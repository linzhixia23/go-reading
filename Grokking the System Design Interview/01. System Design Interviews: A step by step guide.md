

#### 1、前言

很多软件工程师对系统设计面试（SDI）感到很头疼，其主要有三个原因:

* SDI非结构化面试，面试者通常会被问到开放性的设计问题，而这些问题其实并没有标准答案；

* 面试者缺乏大规模复杂系统的开发经验

* 面试者没有花足够的时间来准备系统设计面试
 
就像编程面试一样，面试者如果没有对SDI进行刻意训练，大多数会在像Google、Facebook、Amazon这些公司的面试中表现糟糕。
在这些公司面试中，候选者的表现如果没有超过大部分人，那么获得offer的机会是很少的。
另一方面，如果表现得好，则会有更好的offer（更高的职位和薪水），因为它展示了候选者处理复杂系统的能力。

在这个课程中，我们会使用step-by-step的方法来处理多个系统设计的问题。
现在，让我们来看这些步骤。

#### 2、步骤一：明确需求

我们需要通过提问来明确我们要解决的问题的范围。
设计的问题通常是开放性的，并没有唯一答案，因而尽早明确产生歧义的地方就很重要。
那些花充分时间定义系统最终目标的人，往往更有机会在最终的面试里成功。
当然，由于我们只有35-40分钟来设计一个大的系统，我们需要明确需要关注系统的哪些方面。

我们以设计一个像twitter这样的系统来举例。
这些是在进行设计之前需要明确的问题：

* 我们的用户是否可以发tweet，并关注其他人？

* 我们是否应该设计并展示用户的时间线（timeline）？

* 是否tweets包含照片和视频？

* 我们是否只关注后端，还是也要关注前端？ 

* 用户是否能搜索tweet？ 

* 我们是否需要展示热点话题？ 

* 是否需要推送新的tweet？ 

这些问题会决定我们最终的设计。

#### 3、步骤二：粗略估计

我们需要估计我们要设计的系统的规模。
这对于我们后续关注系统的规模（scaling）、分区（partitioning）、负载均衡（load balancing）和缓存（caching）很有帮助。

* 预期系统的规模有多少（例如：新的tweet的数量、tweet查看的数量、每秒生成的timeline的数量）？

* 我们需要多少存储？如果用户在tweet中使用了照片和视频，则有不同的存储要求。

* 我们期望有多少网络带宽？这决定了我们如何管理网络流量和服务器之间的负载均衡。

#### 4、步骤三：系统接口定义

定义系统期望的api。
这不仅定义系统期望的协议，而且这保证我们没有搞错任何需求。
一些API可能会是这样的：

```
postTweet(user_id, tweet_data, tweet_location, user_location, timestamp, …)  
```

```
generateTimeline(user_id, current_time, user_location, …)  
```

```
markTweetFavorite(user_id, tweet_id, timestamp, …)  
```

#### 5、步骤四：定义数据模型

在面试中，定义数据模型能够明确系统不同的组建之间的数据流。
之后，这会指导数据分区和管理。
候选者需要有能力定义系统不同的部分，以及它们之间如何通信，以及数据管理的不同方面，包括：存储、传输、加密，等等。
以下是我们的twitter系统的一些元素：

**User:** UserID, Name, Email, DoB, CreationData, LastLogin, etc。

**Tweet:** TweetID, Content, TweetLocation, NumberOfLikes, TimeStamp, etc.

**UserFollow:** UserdID1, UserID2

**FavoriteTweets:** UserID, TweetID, TimeStamp

我们需要怎么样的数据库系统？像Cassandra这样的NoSQL，还是像MySQL的系统？
我们需要怎么样的块存储来存图片和视频？ 

#### 6、步骤五：High-level设计

画一个有5-6个box的图来展示系统的核心组件。
我们需要明确需要哪些组件来解决end-to-end的实际问题。

对twitter系统来说，在high-level层次，我们需要多个应用服务来服务所有read/write请求，并保证负载均衡。
如果我们假设读请求相对写请求很大的话，我们可以分出一部分服务器专门处理这些场景。
在后端，我们需要有一个高效的数据库能够存储所有的tweet，并支持大量的读请求。
我们还需要分布式文件系统来存储照片和视频。

![image](https://github.com/linzhixia23/go-reading/blob/master/Grokking%the%System%Design%Interview/pic/section01_pic01.png)

#### 7、步骤六：详细设计

深入挖掘2-3个主要的组件；面试者的反馈应该指导系统的哪个部分需要更深入的讨论。
我们应该展示不同的方法，它们的优点/缺点，为什么用这个方法而不是另一个。
记住，没有唯一的答案；最重要的事情是，始终记住系统的限制，考虑不同选择的tradeoff。

* 由于我们保存了大量的数据，我们要如何把数据分布存储在多个数据库上？是否要把一个用户的所有数据存储在相同的数据库上？它会导致什么问题？ 

* 我们如何处理hot user，它们通常发很多tweet，或者关注很多人？

* 由于用户的时间线包括了大量最近发的tweet，我们是否要按这样的方式存储数据，这样可以优化扫描最新的数据？

* 我们需要多少缓存，以及在哪个层次使用缓存来加速？ 

* 哪个组件需要更好的负载均衡？

#### 8、步骤七：定义并解决系统瓶颈

尝试去尽可能地讨论系统的瓶颈，以及不同的缓解瓶颈的方法。

* 我们的系统是否存在单点失败？如何缓解它？ 

* 我们是否有足够的数据冗余，这样即便部分服务失败了，仍然能够提供服务？

* 类似地，我们的服务是否有足够的副本，使得部分的失败不会导致系统宕机？ 

* 我们如何监控我们服务的性能？我们是否能在系统发生关键失败或者性能降级时，得到告警？ 

#### 9、总结

总而言之，有所准备并且合理组织是系统设计面试的关键。
上面提到的步骤会指导你在系统设计时考虑不同的方面。

我们来使用上述提到的方法来进行几个系统设计。 



